<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Training Plan</title>
<meta name="theme-color" content="#0f172a" />
<style>
  :root { --bg:#0b1020; --card:#11162a; --ink:#e5e7eb; --muted:#aab1c2; --accent:#6ee7b7; --ring:#334155; --ink-dark:#0a0f1e; --red:#ef4444; }
  * { box-sizing: border-box; }
  html, body { margin:0; padding:0; background:linear-gradient(180deg,#0b1020, #0e1326 30%, #0b1020); color:var(--ink); font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans"; }
  a { color: inherit; text-decoration: none; }
  .wrap { max-width: 1040px; margin: 0 auto; padding: 20px; }
  header { display:flex; gap:12px; align-items:center; justify-content:space-between; padding:8px 0 16px; position: sticky; top:0; backdrop-filter: blur(6px); background: rgba(11,16,32,0.7); z-index:10; }
  .title { font-weight:700; letter-spacing:.2px; display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
  .title h1 { margin:0; }
  .title small { opacity:.75; font-weight:500; }
  .toolbar { display:flex; gap:12px; align-items:center; }
  .clock { padding:8px 12px; border:1px solid var(--ring); border-radius:12px; font-variant-numeric: tabular-nums; background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.00)); }
  .btn { border:1px solid var(--ring); background:transparent; color:var(--ink); padding:10px 14px; border-radius:12px; cursor:pointer; font-weight:600; }
  .btn:hover { border-color:#44506a; }
  .btn.sm { padding:6px 10px; font-size:12px; }
  .groups { display:grid; grid-template-columns: repeat(4, minmax(0,1fr)); gap:8px; overflow:auto hidden; padding:8px 0 2px; scrollbar-width:none; }
  .chip { padding:10px 12px; border:1px solid var(--ring); border-radius:999px; text-align:center; white-space:nowrap; cursor:pointer; user-select:none; }
  .chip.active { background:var(--ink); color:var(--ink-dark); border-color:transparent; }
  .grid { display:grid; grid-template-columns: repeat( auto-fill, minmax(260px, 1fr) ); gap:14px; margin-top:16px; }
  .card { border:1px solid var(--ring); background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.00)); border-radius:16px; padding:14px; display:flex; flex-direction:column; gap:10px; min-height:140px; transition: transform .08s ease, border-color .15s ease; }
  .card:hover { transform: translateY(-2px); border-color:#44506a; }
  .media { position:relative; border-radius:12px; overflow:hidden; background:#0f152b; display:flex; align-items:center; justify-content:center; border:1px solid #1f2942; }
  .media.image { aspect-ratio:4/3; }
  .media.video { aspect-ratio:16/9; }
  .media img, .media iframe { width:100%; height:100%; object-fit:cover; display:block; }
  .clickhint{ position:absolute; bottom:6px; right:8px; font-size:11px; color:#cbd5e1; opacity:.8; background:rgba(0,0,0,.25); padding:2px 6px; border-radius:8px; }
  .zoomable { cursor: zoom-in; }
  .badge { font-size:12px; color:var(--ink-dark); background:var(--accent); border-radius:999px; padding:4px 8px; font-weight:700; width:fit-content; }
  .name { font-weight:700; font-size:18px; letter-spacing:.2px; }
  .meta { display:flex; gap:8px; flex-wrap:wrap; align-items:center; color:#cbd5e1; }
  .muscleRow{ display:flex; gap:6px; flex-wrap:wrap; }
  .tagP{ background:rgba(255,255,255,0.06); border:1px solid var(--ring); color:#fde68a; border-radius:999px; padding:3px 8px; font-size:11px; font-weight:700; }
  .tagS{ background:rgba(255,255,255,0.03); border:1px dashed var(--ring); color:#a5b4fc; border-radius:999px; padding:3px 8px; font-size:11px; }
  .empty { opacity:.7; padding:24px; border:1px dashed var(--ring); border-radius:14px; text-align:center; }
  .foot { opacity:.6; font-size:12px; margin:18px 0 6px; text-align:center; }
  .nav { margin-top:12px; display:flex; align-items:center; gap:10px; flex-wrap:wrap; }
  .link { display:inline-flex; align-items:center; gap:8px; padding:8px 12px; border:1px solid var(--ring); border-radius:12px; }
  .dim { color:var(--muted); }
  .detail { display:grid; gap:14px; margin-top:16px; }
  .detail h2 { margin:0; font-size:22px; }
  .two-col { display:grid; gap:14px; grid-template-columns: 1fr; }
  @media (min-width: 900px){ .two-col { grid-template-columns: 1fr 1fr; } }
  .notes { border:1px solid var(--ring); border-radius:14px; padding:12px; color:#d1d5db; background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.00)); }
  .legend { display:flex; flex-wrap:wrap; gap:8px; }
  .tag { border:1px solid var(--ring); border-radius:999px; padding:4px 10px; font-size:12px; color:#cbd5e1; }
  .muscleChips { display:flex; gap:8px; flex-wrap:wrap; margin-top:8px; }
  .mchip { border:1px solid var(--ring); border-radius:999px; padding:6px 10px; font-size:12px; cursor:pointer; user-select:none; }
  .mchip.active { background:var(--ink); color:var(--ink-dark); border-color:transparent; }
  .qrbox { display:none; align-items:center; gap:10px; margin-left:8px; }
  .qrbox input { width:260px; background:transparent; border:1px solid var(--ring); border-radius:10px; padding:10px; color:#var(--ink); outline:none; }
  .qrbox img { width:64px; height:64px; border-radius:8px; border:1px solid var(--ring); background:#0f152b; }
  .maskOverlay{
    position:absolute; inset:0;
    background:var(--red);
    opacity:.85;
    pointer-events:none;
    mask-image: var(--mask-url);
    mask-repeat:no-repeat;
    mask-position:center;
    mask-size:contain;
    -webkit-mask-image: var(--mask-url);
    -webkit-mask-repeat:no-repeat;
    -webkit-mask-position:center;
    -webkit-mask-size:contain;
  }
  .attachGrid{ display:grid; grid-template-columns: repeat(auto-fill, minmax(180px,1fr)); gap:10px; margin-top:8px; }
  .attachItem{ border:1px solid var(--ring); border-radius:12px; padding:10px; display:flex; gap:10px; align-items:center; background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.00)); }
  .attachThumb{ width:64px; height:64px; border-radius:10px; border:1px solid #1f2942; overflow:hidden; background:#0f152b; flex:0 0 64px; }
  .attachThumb img{ width:100%; height:100%; object-fit:cover; display:block; }

  /* Lightbox */
  .lightbox{ position:fixed; inset:0; background:rgba(0,0,0,.88); display:none; align-items:center; justify-content:center; z-index:9999; }
  .lightbox.open{ display:flex; }
  .lb-stage{ position:relative; width: min(96vw, 1400px); height: min(92vh, 90vw); }
  .lb-img, .lb-layer{ position:absolute; inset:0; }
  .lb-img img{ width:100%; height:100%; object-fit:contain; display:block; }
  .lb-close{ position:absolute; top:12px; right:12px; background:rgba(255,255,255,.08); border:1px solid #334155; color:#e5e7eb; border-radius:10px; padding:8px 12px; cursor:pointer; }
  .lb-caption{ position:absolute; left:12px; bottom:12px; color:#cbd5e1; font-size:12px; background:rgba(0,0,0,.35); padding:6px 10px; border-radius:8px; max-width:70ch; }
  .lb-nav{ position:absolute; top:50%; transform:translateY(-50%); width:100%; display:flex; justify-content:space-between; pointer-events:none; }
  .lb-btn{ pointer-events:auto; border:1px solid #334155; background:rgba(255,255,255,.08); color:#e5e7eb; border-radius:10px; padding:10px 14px; cursor:pointer; }
  .uploadRow{ display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
  input[type="file"]{ display:none; }
  .fileLabel{ border:1px solid var(--ring); border-radius:10px; padding:6px 10px; cursor:pointer; font-size:12px; }
</style>
</head>
<body>
<div class="wrap">
  <header>
    <div class="title">
      <h1>Training Plan</h1>
      <small id="planLabel"></small>
    </div>
    <div class="toolbar">
      <div class="clock" id="clock">--/--/---- --:--:--</div>
      <button class="btn" id="shareBtn" title="Copy link to this plan">Share</button>
      <div class="qrbox" id="qrBox">
        <input id="urlInput" placeholder="Paste live URL to make QR" />
        <img id="qrImg" alt="QR code"/>
      </div>
    </div>
  </header>

  <div id="routerView"></div>
  <div class="foot">Click any image to view full screen. Use consistent file names: machine.jpg, muscles.png, handle.jpg.</div>
</div>

<!-- Lightbox -->
<div class="lightbox" id="lightbox" aria-modal="true" role="dialog">
  <div class="lb-stage" id="lbStage" aria-label="Image viewer">
    <div class="lb-img"><img id="lbImg" alt=""></div>
    <div class="lb-layer" id="lbOverlayHost"></div>
    <div class="lb-nav"><button class="lb-btn" id="lbPrev">←</button><button class="lb-btn" id="lbNext">→</button></div>
    <div class="lb-caption" id="lbCap"></div>
    <button class="lb-close" id="lbClose">Close ✕</button>
  </div>
</div>

<script>
  // ---------- EDIT ONLY THIS DATA BLOCK ----------
  // Put images in your repo using: Image/<ExerciseFolder>/{machine.jpg,muscles.png,handle.jpg,...}
  const PLAN = {
    label: "Grouped by Muscle",
    groups: {
      Back: [
        { name: "Warm-up", slug: "back-warmup", order: 1, sets: "10 min",
          youtube: "",
          machine: "Image/BackWarmup/machine.jpg",
          muscles: { primary: [], secondary: [], masks: [] },
          muscleImage: "Image/BackWarmup/muscles.png",
          attachments: [],
          notes: "Light pulldowns/rows, scap pull-ups, band work. Keep it easy."
        },
        { name: "Lat Pulldown (MAG Grip)", slug: "lat-mag", order: 2, sets: "6 × 8",
          youtube: "https://www.youtube.com/shorts/suWROTA8PVY",
          machine: "Image/LatPulldownMagGrip/machine.png",
          muscles: { primary: ["Latissimus dorsi"], secondary: ["Teres major","Biceps"], masks: [] },
          muscleImage: "Image/LatPulldownMagGrip/muscles.jpg",
          attachments: [{ name: "MAG neutral/wide", photo: "Image/LatPulldownMagGrip/handle.jpg" }],
          notes: "Elbows drive to ribs, torso still, full stretch at top."
        },
        { name: "Lat Pulldown (Wide Grip)", slug: "lat-wide", order: 3, sets: "3 × 8",
          youtube: "https://www.youtube.com/shorts/bNmvKpJSWKM",
          machine: "Image/LatPulldownWideGrip/machine.jpg",
          muscles: { primary: ["Latissimus dorsi"], secondary: ["Teres major","Mid traps"], masks: [] },
          muscleImage: "Image/LatPulldownWideGrip/muscles.png",
          attachments: [{ name: "Wide lat bar", photo: "Image/LatPulldownWideGrip/handle.jpg" }],
          notes: "Grip wider than shoulders, chest up, pull to upper chest."
        },
        { name: "Rear Delts", slug: "rear-delts-back", order: 4, sets: "3 × 8",
          youtube: "https://www.youtube.com/shorts/7tgx6QHB0-A",
          machine: "Image/RearDeltsBack/machine.png",
          muscles: { primary: ["Rear delts"], secondary: ["Mid traps","Rhomboids"], masks: [] },
          muscleImage: "Image/RearDeltsBack/muscles.png",
          attachments: [{ name: "Rear-delt machine", photo: "Image/RearDeltsBack/handle.jpg" }],
          notes: "Lead with elbows, no shrug, slight pause at peak."
        },
        { name: "Dumbbell Curl", slug: "dumbbell-curl", order: 5, sets: "3 × 8",
          youtube: "https://www.youtube.com/shorts/FHY_2t7R714",
          machine: "Image/DumbbellCurl/machine.jpg",
          muscles: { primary: ["Biceps brachii"], secondary: ["Brachialis"], masks: [] },
          muscleImage: "Image/DumbbellCurl/muscles.png",
          attachments: [{ name: "Dumbbells", photo: "Image/DumbbellCurl/handle.jpg" }],
          notes: "Wrists neutral, shoulders quiet, control the eccentric."
        },
        { name: "Lateral Raise (Cable)", slug: "lat-raise-cable-back", order: 6, sets: "3 × 8",
          youtube: "https://www.youtube.com/shorts/lMJUXEvcMkQ",
          machine: "Image/LateralRaiseCableBack/machine.png",
          muscles: { primary: ["Medial delts"], secondary: [], masks: [] },
          muscleImage: "Image/LateralRaiseCableBack/muscles.png",
          attachments: [{ name: "Single D-handle", photo: "Image/LateralRaiseCableBack/handle.jpg" }],
          notes: "Soft elbows, raise to shoulder height, avoid shrugging."
        },
        { name: "Leg Raises", slug: "leg-raises-back", order: 7, sets: "3 × 15",
          youtube: "https://www.youtube.com/shorts/Gtv_pe0E42U",
          machine: "Image/LegRaisesBack/machine.jpg",
          muscles: { primary: ["Lower abs","Hip flexors"], secondary: [], masks: [] },
          muscleImage: "Image/LegRaisesBack/muscles.png",
          attachments: [{ name: "Captain’s chair", photo: "Image/LegRaisesBack/handle.jpg" }],
          notes: "Posterior tilt, slow lower, no swinging."
        }
      ],
      Shoulders: [
        { name: "Warm-up", slug: "shoulder-warmup", order: 1, sets: "10 min",
          youtube: "",
          machine: "Image/ShoulderWarmup/machine.jpg",
          muscles: { primary: [], secondary: [], masks: [] },
          muscleImage: "Image/ShoulderWarmup/muscles.png",
          attachments: [],
          notes: "Bands, scapular CARs, light raises. Keep it easy."
        },
        { name: "Shoulder Press", slug: "shoulder-press", order: 2, sets: "3 × 8",
          youtube: "https://www.youtube.com/shorts/k6tzKisR3NY",
          machine: "Image/ShoulderPress/machine.jpg",
          muscles: { primary: ["Anterior delts","Medial delts"], secondary: ["Triceps"], masks: [] },
          muscleImage: "Image/ShoulderPress/muscles.png",
          attachments: [{ name: "Bench + dumbbells/bar", photo: "Image/ShoulderPress/handle.jpg" }],
          notes: "Ribs down, no over-arch, finish with biceps by ears."
        },
        { name: "Lateral Raise", slug: "lateral-raise", order: 3, sets: "3 × 8",
          youtube: "https://www.youtube.com/shorts/Kl3LEzQ5Zqs",
          machine: "Image/LateralRaise/machine.jpg",
          muscles: { primary: ["Medial delts"], secondary: [], masks: [] },
          muscleImage: "Image/LateralRaise/muscles.png",
          attachments: [{ name: "Dumbbells", photo: "Image/LateralRaise/handle.jpg" }],
          notes: "Lead with elbows, slight torso lean OK, controlled tempo."
        },
        { name: "Lateral Raise (Cable)", slug: "lat-raise-cable-shoulder", order: 4, sets: "3 × 8",
          youtube: "https://www.youtube.com/shorts/lMJUXEvcMkQ",
          machine: "Image/LateralRaiseCableShoulder/machine.png",
          muscles: { primary: ["Medial delts"], secondary: [], masks: [] },
          muscleImage: "Image/LateralRaiseCableShoulder/muscles.png",
          attachments: [{ name: "Single D-handle", photo: "Image/LateralRaiseCableShoulder/handle.jpg" }],
          notes: "Cable behind body, raise to about 90°, no shrug."
        },
        { name: "Machine Shoulder Press", slug: "machine-shoulder-press", order: 5, sets: "3 × 8",
          youtube: "https://www.youtube.com/shorts/6v4nrRVySj0",
          machine: "Image/MachineShoulderPress/machine.png",
          muscles: { primary: ["Anterior delts","Medial delts"], secondary: ["Triceps"], masks: [] },
          muscleImage: "Image/MachineShoulderPress/muscles.png",
          attachments: [{ name: "Machine handles", photo: "Image/MachineShoulderPress/handle.jpg" }],
          notes: "Seat height so handles start at jaw-chin level. Smooth reps."
        },
        { name: "Zottman Curl", slug: "zottman-curl", order: 6, sets: "3 × 8",
          youtube: "https://www.youtube.com/watch?v=wrjEdVZrkhk",
          machine: "Image/ZottmanCurl/machine.jpg",
          muscles: { primary: ["Biceps brachii","Brachioradialis"], secondary: ["Forearms"], masks: [] },
          muscleImage: "Image/ZottmanCurl/muscles.png",
          attachments: [{ name: "Dumbbells", photo: "Image/ZottmanCurl/handle.jpg" }],
          notes: "Supinated up, pronated down. Control the rotation."
        },
        { name: "Triceps Rope", slug: "triceps-rope", order: 7, sets: "3 × 8",
          youtube: "https://www.youtube.com/watch?v=JDEDaZTEzGE",
          machine: "Image/TricepsRope/machine.png",
          muscles: { primary: ["Triceps"], secondary: [], masks: [] },
          muscleImage: "Image/TricepsRope/muscles.png",
          attachments: [{ name: "Rope", photo: "Image/TricepsRope/handle.jpeg" }],
          notes: "Elbows pinned, spread rope at the bottom, full lockout."
        },
        { name: "Leg Raises", slug: "leg-raises-shoulder", order: 8, sets: "3 × 15",
          youtube: "https://www.youtube.com/shorts/Gtv_pe0E42U",
          machine: "Image/LegRaisesShoulder/machine.jpg",
          muscles: { primary: ["Lower abs","Hip flexors"], secondary: [], masks: [] },
          muscleImage: "Image/LegRaisesShoulder/muscles.png",
          attachments: [{ name: "Captain’s chair", photo: "Image/LegRaisesShoulder/handle.jpg" }],
          notes: "Posterior tilt, slow eccentric, no momentum."
        }
      ],
      Chest: [
        { name: "Warm-up", slug: "chest-warmup", order: 1, sets: "10 min",
          youtube: "",
          machine: "Image/ChestWarmup/machine.jpg",
          muscles: { primary: [], secondary: [], masks: [] },
          muscleImage: "Image/ChestWarmup/muscles.png",
          attachments: [],
          notes: "Scap push-ups, band pull-aparts, light presses."
        },
        { name: "Chest Press (Dumbbell)", slug: "chest-press-dumbbell", order: 2, sets: "3 × 8",
          youtube: "https://www.youtube.com/shorts/8fXfwG4ftaQ",
          machine: "Image/ChestPressDumbbell/machine.jpg",
          muscles: { primary: ["Pectoralis major"], secondary: ["Anterior delts","Triceps"], masks: [] },
          muscleImage: "Image/ChestPressDumbbell/muscles.png",
          attachments: [{ name: "Flat bench + dumbbells", photo: "Image/ChestPressDumbbell/handle.jpg" }],
          notes: "Wrists stacked, slight arch, control the touch on chest."
        },
        { name: "Chest Press (Machine)", slug: "chest-press-machine", order: 3, sets: "3 × 8",
          youtube: "https://www.youtube.com/watch?v=vnd-GBtTMLI",
          machine: "Image/ChestPressMachine/machine.png",
          muscles: { primary: ["Pectoralis major"], secondary: ["Anterior delts","Triceps"], masks: [] },
          muscleImage: "Image/ChestPressMachine/muscles.png",
          attachments: [{ name: "Machine handles", photo: "Image/ChestPressMachine/handle.jpg" }],
          notes: "Seat so handles align mid-chest; steady tempo."
        },
        { name: "Chest Fly", slug: "chest-fly", order: 4, sets: "3 × 8",
          youtube: "https://www.youtube.com/shorts/rk8YayRoTRQ",
          machine: "Image/ChestFly/machine.jpeg",
          muscles: { primary: ["Pectoralis major"], secondary: ["Anterior delts"], masks: [] },
          muscleImage: "Image/ChestFly/muscles.png",
          attachments: [{ name: "Pec deck or cables", photo: "Image/ChestFly/handle.jpg" }],
          notes: "Soft elbows, big stretch, squeeze at midline."
        },
        { name: "Chest Machine", slug: "chest-machine", order: 5, sets: "3 × 8",
          youtube: "https://www.youtube.com/shorts/2awX3rTGa1k",
          machine: "Image/ChestMachine/machine.png",
          muscles: { primary: ["Pectoralis major"], secondary: ["Anterior delts","Triceps"], masks: [] },
          muscleImage: "Image/ChestMachine/muscles.png",
          attachments: [{ name: "Machine handles", photo: "Image/ChestMachine/handle.jpg" }],
          notes: "Scapulae retracted, no bouncing, full range."
        },
        { name: "Skullcrushers", slug: "skullcrushers", order: 6, sets: "3 × 8",
          youtube: "https://www.youtube.com/shorts/whUDFbWQjBI",
          machine: "Image/Skullcrushers/machine.jpg",
          muscles: { primary: ["Triceps (long head)"], secondary: [], masks: [] },
          muscleImage: "Image/Skullcrushers/muscles.png",
          attachments: [{ name: "EZ-bar or dumbbells", photo: "Image/Skullcrushers/handle.jpg" }],
          notes: "Upper arms stable, lower to behind head for stretch."
        },
        { name: "Rear Delts", slug: "rear-delts-chest", order: 7, sets: "3 × 8",
          youtube: "https://www.youtube.com/shorts/Gs4e8eVMj-Q",
          machine: "Image/RearDeltsChest/machine.png",
          muscles: { primary: ["Rear delts"], secondary: ["Mid traps","Rhomboids"], masks: [] },
          muscleImage: "Image/RearDeltsChest/muscles.png",
          attachments: [{ name: "Reverse pec deck or cables", photo: "Image/RearDeltsChest/handle.jpg" }],
          notes: "Control the last 30°; no momentum, no shrug."
        },
        { name: "Leg Raises", slug: "leg-raises-chest", order: 8, sets: "3 × 15",
          youtube: "https://www.youtube.com/shorts/Gtv_pe0E42U",
          machine: "Image/LegRaisesChest/machine.jpg",
          muscles: { primary: ["Lower abs","Hip flexors"], secondary: [], masks: [] },
          muscleImage: "Image/LegRaisesChest/muscles.png",
          attachments: [{ name: "Captain’s chair or bar", photo: "Image/LegRaisesChest/handle.jpg" }],
          notes: "Posterior tilt, heels together, slow lower."
        }
      ],
      Legs: []
    }
  };
  // ---------- STOP EDITING HERE ----------

  const GROUP_ORDER = ["Back","Chest","Shoulders","Legs"];
  const routerView = document.getElementById("routerView");
  const planLabel = document.getElementById("planLabel");
  const shareBtn = document.getElementById("shareBtn");
  const qrBox = document.getElementById("qrBox");
  const urlInput = document.getElementById("urlInput");
  const qrImg = document.getElementById("qrImg");
  const clockEl = document.getElementById("clock");

  planLabel.textContent = PLAN.label || "";

  // EU clock dd/mm/yyyy HH:MM:SS
  function two(n){ return String(n).padStart(2,"0"); }
  function formatEU(d){ return `${two(d.getDate())}/${two(d.getMonth()+1)}/${d.getFullYear()} ${two(d.getHours())}:${two(d.getMinutes())}:${two(d.getSeconds())}`; }
  function tick(){ clockEl.textContent = formatEU(new Date()); }
  tick(); setInterval(tick, 1000);

  function slugify(s){ return String(s||"").toLowerCase().replace(/[^a-z0-9]+/g,"-").replace(/(^-|-$)/g,""); }
  function navTo(hash){ location.hash = hash; }
  function byOrder(a,b){ return (a.order||999) - (b.order||999); }

  function toYouTubeEmbed(u){
    try{
      const url=new URL(u);
      if(url.hostname==="youtu.be"){ return "https://www.youtube.com/embed/"+url.pathname.slice(1); }
      const id = url.searchParams.get("v");
      if(id) return "https://www.youtube.com/embed/"+id;
      if(url.pathname.startsWith("/shorts/")) return "https://www.youtube.com/embed/"+url.pathname.split("/")[2];
    }catch(e){}
    return u;
  }

  /* ---------- Lightbox helpers ---------- */
  const lightbox = document.getElementById("lightbox");
  const lbImg = document.getElementById("lbImg");
  const lbCap = document.getElementById("lbCap");
  const lbOverlayHost = document.getElementById("lbOverlayHost");
  const lbClose = document.getElementById("lbClose");
  const lbPrev = document.getElementById("lbPrev");
  const lbNext = document.getElementById("lbNext");
  let gallery = [];   // [{src, alt, overlays:[url], caption}]
  let gIndex = 0;

  function openLightbox(items, startIndex=0){
    gallery = items || [];
    gIndex = Math.max(0, Math.min(startIndex, gallery.length-1));
    renderLightbox();
    lightbox.classList.add("open");
    document.body.style.overflow = "hidden";
    updateNavButtons();
  }
  function closeLightbox(){
    lightbox.classList.remove("open");
    lbOverlayHost.innerHTML = "";
    document.body.style.overflow = "";
  }
  function updateNavButtons(){
    const multi = gallery.length > 1;
    lbPrev.style.display = multi ? "" : "none";
    lbNext.style.display = multi ? "" : "none";
  }
  function renderLightbox(){
    const item = gallery[gIndex];
    if (!item) return;
    lbImg.src = item.src;
    lbImg.alt = item.alt || "";
    lbCap.textContent = item.caption || "";
    lbOverlayHost.innerHTML = "";
    (item.overlays || []).forEach(url=>{
      const ov = document.createElement("div");
      ov.className = "maskOverlay";
      ov.style.setProperty("--mask-url", `url(${url})`);
      lbOverlayHost.appendChild(ov);
    });
  }
  lbClose.onclick = closeLightbox;
  lightbox.addEventListener("click", e=>{
    if (e.target === lightbox) closeLightbox();
  });
  document.addEventListener("keydown", e=>{
    if (!lightbox.classList.contains("open")) return;
    if (e.key === "Escape") closeLightbox();
    if (e.key === "ArrowRight" && gIndex < gallery.length-1){ gIndex++; renderLightbox(); }
    if (e.key === "ArrowLeft" && gIndex > 0){ gIndex--; renderLightbox(); }
  });
  lbNext.onclick = ()=>{ if (gIndex < gallery.length-1){ gIndex++; renderLightbox(); } };
  lbPrev.onclick = ()=>{ if (gIndex > 0){ gIndex--; renderLightbox(); } };

  function makeZoomable(el, getItem){
    el.classList.add("zoomable");
    const hint = document.createElement("div");
    hint.className = "clickhint";
    hint.textContent = "Click to view";
    el.appendChild(hint);
    el.addEventListener("click", ()=>{
      const item = getItem();
      if (!item) return;
      openLightbox([item], 0);
    });
  }
  function makeGalleryZoomable(container, items){
    container.querySelectorAll(".zoomable").forEach(z=>{
      z.addEventListener("click", ()=>{
        openLightbox(items, 0);
      });
    });
  }

  /* ---------- UI renderers ---------- */
  function renderGroupsBar(active){
    const bar = document.createElement("div");
    bar.className = "groups";
    GROUP_ORDER.forEach(g=>{
      const chip = document.createElement("div");
      chip.className = "chip"+(g===active?" active":"");
      chip.textContent = g;
      chip.onclick = ()=> navTo(`#/group/${encodeURIComponent(g)}`);
      bar.appendChild(chip);
    });
    return bar;
  }

  function renderGroupView(group){
    const list = (PLAN.groups[group]||[]).slice().sort(byOrder);
    routerView.innerHTML = "";
    routerView.appendChild(renderGroupsBar(group));

    const head = document.createElement("div");
    head.className = "nav";
    head.innerHTML = `<span class="dim">Showing</span> <strong>${group}</strong>`;
    routerView.appendChild(head);

    if (!list.length){
      const empty = document.createElement("div");
      empty.className = "empty";
      empty.textContent = "Empty. Either intentional recovery or accidental procrastination.";
      routerView.appendChild(empty);
      return;
    }

    const grid = document.createElement("div");
    grid.className = "grid";
    list.forEach(ex=>{
      const card = document.createElement("div");
      card.className = "card";
      card.style.cursor = "pointer";

      const row = document.createElement("div");
      row.style.display="flex"; row.style.alignItems="center"; row.style.justifyContent="space-between";
      const name = document.createElement("div");
      name.className = "name";
      name.textContent = `${ex.order ? ex.order+". " : ""}${ex.name}`;
      const badge = document.createElement("div");
      badge.className = "badge";
      badge.textContent = ex.sets || "";
      row.appendChild(name); row.appendChild(badge);
      card.appendChild(row);

      const meta = document.createElement("div");
      meta.className = "meta";
      meta.textContent = "Tap to open details";
      card.appendChild(meta);

      const musclesRow = document.createElement("div");
      musclesRow.className = "muscleRow";
      (ex.muscles?.primary||[]).forEach(m=>{ const t=document.createElement("span"); t.className="tagP"; t.textContent=m; musclesRow.appendChild(t); });
      (ex.muscles?.secondary||[]).forEach(m=>{ const t=document.createElement("span"); t.className="tagS"; t.textContent=m; musclesRow.appendChild(t); });
      card.appendChild(musclesRow);

      card.onclick = ()=> navTo(`#/exercise/${encodeURIComponent(group)}/${encodeURIComponent(ex.slug||slugify(ex.name))}`);
      grid.appendChild(card);
    });
    routerView.appendChild(grid);
  }

  function pill(text){
    const span = document.createElement("span");
    span.className = "tag";
    span.textContent = text;
    return span;
  }
  function lsKey(group, slug){ return `muscleImage:${group}:${slug}`; }

  function renderMuscleBox(group, slug, ex){
    const musclesBox = document.createElement("div");
    musclesBox.className = "card";

    const topRow = document.createElement("div");
    topRow.style.display = "flex";
    topRow.style.alignItems = "center";
    topRow.style.justifyContent = "space-between";
    const musclesTitle = document.createElement("div");
    musclesTitle.className = "name";
    musclesTitle.textContent = "Target muscles";
    topRow.appendChild(musclesTitle);

    const uploadControls = document.createElement("div");
    uploadControls.className = "uploadRow";
    const fileInput = document.createElement("input");
    fileInput.type = "file"; fileInput.accept = "image/*"; fileInput.id = "file-"+group+"-"+slug;
    const label = document.createElement("label");
    label.className = "fileLabel"; label.setAttribute("for", fileInput.id);
    label.textContent = "Upload muscle image (local)";
    const clearBtn = document.createElement("button");
    clearBtn.className = "btn sm"; clearBtn.textContent = "Clear local";
    uploadControls.appendChild(fileInput);
    uploadControls.appendChild(label);
    uploadControls.appendChild(clearBtn);
    topRow.appendChild(uploadControls);

    musclesBox.appendChild(topRow);

    const muscleMedia = document.createElement("div");
    muscleMedia.className = "media image";
    const imgMuscle = document.createElement("img");
    const local = localStorage.getItem(lsKey(group, slug));
    imgMuscle.src = local || ex.muscleImage || "";
    imgMuscle.alt = "Muscle targets";
    imgMuscle.loading = "lazy";
    muscleMedia.appendChild(imgMuscle);

    const overlayHost = document.createElement("div");
    overlayHost.style.position = "absolute";
    overlayHost.style.inset = "0";
    overlayHost.style.pointerEvents = "none";
    muscleMedia.appendChild(overlayHost);
    musclesBox.appendChild(muscleMedia);

    const chipRow = document.createElement("div");
    chipRow.className = "muscleChips";
    musclesBox.appendChild(chipRow);

    const legend = document.createElement("div");
    legend.className = "legend";
    const primaries = (ex.muscles?.primary||[]);
    const secondaries = (ex.muscles?.secondary||[]);
    if (primaries.length){ legend.appendChild(pill("Primary: " + primaries.join(", "))); }
    if (secondaries.length){ legend.appendChild(pill("Secondary: " + secondaries.join(", "))); }
    musclesBox.appendChild(legend);

    const masks = (ex.muscles?.masks||[]).map(m=>({...m}));
    function renderOverlays(host){
      host.innerHTML = "";
      masks.forEach(m=>{
        if (!m.active) return;
        const ov = document.createElement("div");
        ov.className = "maskOverlay";
        ov.style.setProperty("--mask-url", `url(${m.url})`);
        host.appendChild(ov);
      });
    }
    function renderChips(){
      chipRow.innerHTML = "";
      masks.forEach(m=>{
        const c = document.createElement("span");
        c.className = "mchip"+(m.active?" active":"");
        c.textContent = m.name || "Mask";
        c.onclick = ()=>{ m.active = !m.active; renderChips(); renderOverlays(overlayHost); };
        chipRow.appendChild(c);
      });
    }
    renderChips();
    renderOverlays(overlayHost);

    // Upload handlers (local only)
    fileInput.onchange = (e)=>{
      const file = e.target.files?.[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = ()=>{
        try{ localStorage.setItem(lsKey(group, slug), reader.result); }
        catch(err){ alert("Image too large for local storage. Upload to your repo and set muscleImage to that path."); }
        imgMuscle.src = reader.result;
      };
      reader.readAsDataURL(file);
    };
    clearBtn.onclick = ()=>{
      localStorage.removeItem(lsKey(group, slug));
      imgMuscle.src = ex.muscleImage || "";
    };

    // Make the muscle image zoomable with overlays mirrored
    makeZoomable(muscleMedia, ()=>{
      const activeMasks = masks.filter(m=>m.active).map(m=>m.url);
      return { src: imgMuscle.src, alt: imgMuscle.alt, overlays: activeMasks, caption: "Target muscles" };
    });

    return musclesBox;
  }

  function renderAttachmentBox(ex){
    const atts = ex.attachments || [];
    const attBox = document.createElement("div");
    attBox.className = "card";
    const attHead = document.createElement("div");
    attHead.className = "name";
    attHead.textContent = "Attachments";
    attBox.appendChild(attHead);

    if (!atts.length){
      const none = document.createElement("div");
      none.className = "dim";
      none.textContent = "No special attachment needed.";
      attBox.appendChild(none);
    } else {
      const grid = document.createElement("div");
      grid.className = "attachGrid";
      const items = [];
      atts.forEach(a=>{
        const item = document.createElement("div");
        item.className = "attachItem";
        const thumb = document.createElement("div");
        thumb.className = "attachThumb zoomable";
        const im = document.createElement("img");
        im.src = a.photo || "";
        im.alt = a.name;
        thumb.appendChild(im);
        const label = document.createElement("div");
        label.textContent = a.name;
        item.appendChild(thumb);
        item.appendChild(label);
        grid.appendChild(item);
        items.push({ src: im.src, alt: a.name, caption: a.name });
      });
      attBox.appendChild(grid);
      makeGalleryZoomable(attBox, items);
    }
    return attBox;
  }

  function renderNotesBox(ex){
    const notes = document.createElement("div");
    notes.className = "notes";
    notes.textContent = ex.notes || "No notes. Breathe, move well, don’t be reckless.";
    return notes;
  }

  function renderExerciseView(group, slug){
    const list = (PLAN.groups[group]||[]).slice().sort(byOrder);
    const ex = list.find(e => (e.slug||slugify(e.name)) === slug);
    routerView.innerHTML = "";
    routerView.appendChild(renderGroupsBar(group));

    const back = document.createElement("div");
    back.className = "nav";
    const backLink = document.createElement("a");
    backLink.className = "link";
    backLink.href = `#/group/${encodeURIComponent(group)}`;
    backLink.textContent = "← Back to " + group;
    back.appendChild(backLink);
    routerView.appendChild(back);

    if (!ex){
      const empty = document.createElement("div");
      empty.className = "empty";
      empty.textContent = "Exercise not found. Either it was renamed or abducted by bad form.";
      routerView.appendChild(empty);
      return;
    }

    const section = document.createElement("section");
    section.className = "detail";

    const heading = document.createElement("h2");
    heading.textContent = ex.name;
    section.appendChild(heading);

    const meta = document.createElement("div");
    meta.className = "meta";
    const badge = document.createElement("div");
    badge.className = "badge";
    badge.textContent = ex.sets || "";
    meta.appendChild(badge);
    section.appendChild(meta);

    const targets = document.createElement("div");
    targets.className = "muscleRow";
    (ex.muscles?.primary||[]).forEach(m=>{ const t=document.createElement("span"); t.className="tagP"; t.textContent=m; targets.appendChild(t); });
    (ex.muscles?.secondary||[]).forEach(m=>{ const t=document.createElement("span"); t.className="tagS"; t.textContent=m; targets.appendChild(t); });
    section.appendChild(targets);

    // Video + Machine
    const mediaWrap = document.createElement("div");
    mediaWrap.className = "two-col";

    // Video card with header
    const videoBox = document.createElement("div");
    videoBox.className = "card";
    const vHead = document.createElement("div");
    vHead.className = "name";
    vHead.textContent = "How to do it";
    videoBox.appendChild(vHead);
    const video = document.createElement("div");
    video.className = "media video";
    const iframe = document.createElement("iframe");
    iframe.src = toYouTubeEmbed(ex.youtube||"");
    iframe.title = ex.name + " video";
    iframe.loading = "lazy";
    iframe.allow = "accelerometer; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share";
    iframe.referrerPolicy = "strict-origin-when-cross-origin";
    video.appendChild(iframe);
    videoBox.appendChild(video);

    // Machine card with header
    const machineBox = document.createElement("div");
    machineBox.className = "card";
    const pHead = document.createElement("div");
    pHead.className = "name";
    pHead.textContent = "Machine to use";
    machineBox.appendChild(pHead);
    const machineMedia = document.createElement("div");
    machineMedia.className = "media image";
    const imgMachine = document.createElement("img");
    imgMachine.src = ex.machine || "";
    imgMachine.alt = ex.name + " machine";
    imgMachine.loading = "lazy";
    machineMedia.appendChild(imgMachine);
    machineBox.appendChild(machineMedia);

    mediaWrap.appendChild(videoBox);
    mediaWrap.appendChild(machineBox);
    section.appendChild(mediaWrap);

    // Zoomable machine
    makeZoomable(machineMedia, ()=>({ src: imgMachine.src, alt: imgMachine.alt, caption: "Machine to use" }));

    // Muscles, Attachments, Notes
    section.appendChild(renderMuscleBox(group, slug, ex));
    section.appendChild(renderAttachmentBox(ex));
    section.appendChild(renderNotesBox(ex));

    routerView.appendChild(section);
  }

  function router(){
    const hash = location.hash || "";
    const parts = hash.split("/").map(x=>decodeURIComponent(x.replace(/^#*/, "")));
    if (parts[1] === "exercise" && parts.length >= 4){
      const group = parts[2];
      const slug = parts[3];
      renderExerciseView(group, slug);
    } else {
      const group = (parts[1] === "group" && parts[2]) ? parts[2] : GROUP_ORDER[0];
      renderGroupView(group);
    }
  }
  window.addEventListener("hashchange", router);
  router();

  // Share + QR helper
  shareBtn.addEventListener("click", async ()=> {
    const url = location.href;
    try{
      await navigator.clipboard.writeText(url);
      shareBtn.textContent = "Link copied";
      setTimeout(()=>shareBtn.textContent="Share",1400);
    }catch(e){
      if (navigator.share) {
        try { await navigator.share({ title: document.title, url }); } catch(_) {}
      } else {
        alert(url);
      }
    }
    qrBox.style.display = "flex";
    urlInput.value = url;
    updateQR();
  });
  function updateQR(){
    const u = encodeURIComponent((urlInput.value||"").trim());
    if (!u){ qrImg.src=""; return; }
    qrImg.src = `https://chart.googleapis.com/chart?cht=qr&chs=256x256&chld=M|0&chl=${u}`;
  }
  urlInput.addEventListener("input", updateQR);
</script>
</body>
</html>
